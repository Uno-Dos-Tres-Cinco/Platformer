<!doctype html>
<html>
<head>
    <title>L</title>
    <script src="https://cdn.jsdelivr.net/npm/phaser@3.55.2/dist/phaser.js"></script>
</head>
<body>
    <script>
        var config = {
            type: Phaser.AUTO,
            width: 1700,
            height: 900,
            backgroundColor: "#658cf0",
            physics: {
                default: "arcade"
            },

            scene: {
                preload: preload,
                create: create,
                update: update
            }
        };

        class Player extends Phaser.Physics.Arcade.Sprite {
            constructor(scene, x, y) {
                super(scene, x, y, "player");
                scene.add.existing(this);
                scene.physics.add.existing(this);
                this.setScale(2);
                this.setCollideWorldBounds(false);
                this.setGravityY(3000); 
            }
        }

        var game = new Phaser.Game(config);

        var platforms;
        var player;
        var bounceBlocks;
        var fallingBlocks;

        var cursors;
        var keys;
        var space;
        var jumpBuffer = 0;
        var coyoteFrames = 0;

        function preload() {
            this.load.image("platform", "assets/platform.png");
            this.load.image("player", "assets/player.png");
            this.load.image("grass", "assets/grass.png");
            this.load.image("mountains", "assets/mountains.png");
            this.load.image("stud", "assets/stud.png");
            this.load.image("vertPlat", "assets/vertical_platform.png");
            this.load.image("bounceBlock", "assets/slime.png"); 
            this.load.image("fallingBlock", "assets/falling_plat.png"); 
            this.load.image("dirt", "assets/dirt.png"); 
            this.load.image('trust_me_bro', 'assets/trust.png');
        }

        function create() {
            this.add.image(1620, -1400, "trust_me_bro");
            createMountains(this);
            createPlatforms(this);

            player = new Player(this, 400, 400);
            this.physics.add.collider(player, platforms);

            bounceBlocks = this.physics.add.staticGroup();
            bounceBlocks.create(100, -950, "bounceBlock"); 

            this.physics.add.collider(player, bounceBlocks, bounce, null, this);

            fallingBlocks = this.physics.add.group();
            createFallingBlock(this, 650, -1100);
           	createFallingBlock(this, 900, -1100);
           	createFallingBlock(this, 1250, -1100);
           	createFallingBlock(this, 3900, -600);
           	createFallingBlock(this, 3900, -750);
           	createFallingBlock(this, 3900, -900);

            this.physics.add.collider(player, fallingBlocks, (player, block) => {
                if (player.body.touching.down && block.body.touching.up) {
                    fall(player, block);
                }
            }, null, this);

            this.grass = this.add.tileSprite(
                0,
                1515,
                this.game.scale.width * 2,
                this.game.scale.height * 2,
                "grass"
            );

            cursors = this.input.keyboard.createCursorKeys();
            keys = this.input.keyboard.addKeys("A, D, W, R");
            space = this.input.keyboard.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
            space.on("down", jump);
            cursors.up.on("down", jump);
            keys.W.on("down", jump);

            this.cameras.main.startFollow(player);
        }

        function createMountains(scene) {
            const mountainWidth = 1700;
            const numberOfMountains = 5;
            const dirtDepth = 1;

            for (let i = -numberOfMountains; i <= numberOfMountains; i++) {
                let mountainX = i * mountainWidth + mountainWidth / 2;

                scene.add.tileSprite(
                    mountainX,
                    450,
                    mountainWidth,
                    scene.game.scale.height,
                    "mountains"
                );

                for (let j = 1; j <= dirtDepth; j++) {
                    scene.add.tileSprite(
                        mountainX,
                        450 + (j * scene.game.scale.height),
                        mountainWidth,
                        scene.game.scale.height,
                        "dirt"
                    );
                }
            }
        }

        function createPlatforms(scene) {
            platforms = scene.physics.add.staticGroup();

            let basePlatform = platforms.create(game.scale.width / 2, game.scale.height - 30, "platform");
           	let basePlatform2 = platforms.create(2300, -300, "platform");
                	basePlatform.setScale(10, 1).refreshBody(); // scales the base platform in the x axis to cover the entire floor
                	basePlatform2.setScale(5,1).refreshBody();

                	platforms.create(600, 650, "platform"); // creates the upper left platform
                	platforms.create(950, 750, "platform"); // creates the bottom right platform
                	platforms.create(300, 550, "platform");
                	platforms.create(100, 400, "platform");
                	platforms.create(300, 250, "platform");
                	platforms.create(500, 125, "platform");
                	platforms.create(900, 0, "platform");
                	platforms.create(1300, -125, "platform");
                	platforms.create(1300, -275, "platform");
                	platforms.create(900, -300, "stud");
                	platforms.create(700, -350, "stud");
                	platforms.create(500, -450, "stud");
                	platforms.create(500, -600, "stud");
                	platforms.create(300, -600, "vertPlat");
                	platforms.create(300, -900, "vertPlat");
                	platforms.create(300, -1050, "vertPlat");
                	platforms.create(268, -850, "stud");
                	platforms.create(1550, -1050, "vertPlat");
                	platforms.create(1520, -1250, "stud");
                	platforms.create(1550, -1150, "vertPlat");
                	platforms.create(1550, -1250, "vertPlat");
                	platforms.create(1550, -1350, "vertPlat");
                	platforms.create(1520, -1100, "stud");
                	platforms.create(1520, -1250, "stud");
                	platforms.create(500, 125, "platform");
                	platforms.create(3000, -450, "platform");
                	platforms.create(3350, -450, "stud");
                	platforms.create(3700, -500, 'stud');
                	platforms.create(4100, -900, 'platform');
            }
        

        function createBounceBlock(scene, x, y) {
            bounceBlocks.create(x, y, "bounceBlock");
        }

        function createFallingBlock(scene, x, y) {
            let fallingBlock = scene.physics.add.image(x, y, "fallingBlock");
            fallingBlocks.add(fallingBlock);
            fallingBlock.setImmovable(true);
            fallingBlock.body.allowGravity = false;
            fallingBlock.originalY = y; 
            fallingBlock.originalX = x;
        }

        function fall(player, fallingBlock) {
            fallingBlock.setImmovable(false);
            fallingBlock.body.allowGravity = true;
            fallingBlock.body.setVelocityX(0);
            fallingBlock.body.setVelocityY(1000);

            player.scene.time.delayedCall(3000, function () {
                fallingBlock.setPosition(fallingBlock.originalX, fallingBlock.originalY);
                fallingBlock.setImmovable(true);
                fallingBlock.body.allowGravity = false;
                fallingBlock.setVelocityY(0);
                fallingBlock.setVelocityX(0);
                
            });
        }

        function bounce(player, bounceBlock) {
            if (player.body.touching.down && bounceBlock.body.touching.up) {
                player.setVelocityY(-1600); 
            }
        }

        function update() {
            player.setVelocityX(0);

            player.setDragX(1000);

            if (cursors.left.isDown || keys.A.isDown) {
                player.setVelocityX(-400);
            }

            if (cursors.right.isDown || keys.D.isDown) {
                player.setVelocityX(400);
            }

            if (player.body.touching.down) {
                coyoteFrames = 8;
            }

            if ((player.body.touching.down || coyoteFrames > 0) && jumpBuffer > 0) {
                player.setVelocityY(-1100);
                jumpBuffer = 0;
                coyoteFrames = 0;
            }

            if (keys.R.isDown) {
                player.setVelocityY(-2000);
            }

            if (jumpBuffer > 0) {
                jumpBuffer--;
            }

            if (coyoteFrames > 0) {
                coyoteFrames--;
            }
        }

        function jump(event) {
            if (player.body.touching.down || coyoteFrames > 0) {
                player.setVelocityY(-1100);
                coyoteFrames = 0;
            } else {
                jumpBuffer = 8;
            }
        }
    </script>
</body>
</html>
